"use strict";(()=>{var e={};e.id=1734,e.ids=[1734],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},36138:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>y,originalPathname:()=>q,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>b});var t={};s.r(t),s.d(t,{DELETE:()=>h,GET:()=>l,POST:()=>m});var a=s(95815),i=s(51150),n=s(10007),o=s(30596),u=s(2381),d=s(90453),c=s(11123);async function l(e,{params:r}){try{let s=await d.Sy.authenticateRequest(e);if(!s||!d.Sy.hasPermission(s,"read:queue"))return o.Z.json({error:"Unauthorized"},{status:401});let t=r.id,a=await c.c.get(t);if(!a)return o.Z.json({error:"Job not found"},{status:404});if("admin"!==s.role&&a.metadata.userId!==s.id&&a.metadata.dealerId!==s.dealerId)return o.Z.json({error:"Access denied"},{status:403});return o.Z.json({job:a})}catch(e){return u.kg.error("Queue job details API error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Internal server error"},{status:500})}}async function h(e,{params:r}){try{let s=await d.Sy.authenticateRequest(e);if(!s||!d.Sy.hasPermission(s,"write:queue"))return o.Z.json({error:"Unauthorized"},{status:401});let t=r.id,a=await c.c.get(t);if(!a)return o.Z.json({error:"Job not found"},{status:404});if("admin"!==s.role&&a.metadata.userId!==s.id&&a.metadata.dealerId!==s.dealerId)return o.Z.json({error:"Access denied"},{status:403});if(!await c.c.cancel(t))return o.Z.json({error:"Job cannot be cancelled (already processing or completed)"},{status:400});return u.kg.info("Job cancelled via API",{jobId:t,userId:s.id}),o.Z.json({success:!0,message:"Job cancelled successfully"})}catch(e){return u.kg.error("Queue job cancellation error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Failed to cancel job",details:e instanceof Error?e.message:String(e)},{status:500})}}async function m(e,{params:r}){try{let s,t;let a=await d.Sy.authenticateRequest(e);if(!a||!d.Sy.hasPermission(a,"write:queue"))return o.Z.json({error:"Unauthorized"},{status:401});let{action:i}=await e.json();if(!i)return o.Z.json({error:"action is required"},{status:400});let n=r.id,l=await c.c.get(n);if(!l)return o.Z.json({error:"Job not found"},{status:404});if("admin"!==a.role&&l.metadata.userId!==a.id&&l.metadata.dealerId!==a.dealerId)return o.Z.json({error:"Access denied"},{status:403});switch(i){case"retry":t=(s=await c.c.retry(n))?"Job queued for retry":"Job cannot be retried";break;case"cancel":t=(s=await c.c.cancel(n))?"Job cancelled successfully":"Job cannot be cancelled";break;default:return o.Z.json({error:`Unknown action: ${i}`},{status:400})}return s&&u.kg.info("Job action executed",{jobId:n,action:i,userId:a.id}),o.Z.json({success:s,message:t})}catch(e){return u.kg.error("Queue job action error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Failed to execute job action",details:e instanceof Error?e.message:String(e)},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/queue/job/[id]/route",pathname:"/api/queue/job/[id]",filename:"route",bundlePath:"app/api/queue/job/[id]/route"},resolvedPagePath:"/Users/briankramer/Documents/GitHub/dealership-ai/apps/web/app/api/queue/job/[id]/route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:g,headerHooks:y,staticGenerationBailout:b}=p,q="/api/queue/job/[id]/route";function x(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},90453:(e,r,s)=>{s.d(r,{Sy:()=>u});var t=s(2381);let a={admin:["read:dashboard","write:dashboard","read:batches","write:batches","read:queue","write:queue","read:admin","write:admin","read:costs","write:costs"],dealer:["read:dashboard","write:dashboard","read:batches","write:batches","read:queue","read:costs"],user:["read:dashboard","read:batches","read:queue"],viewer:["read:dashboard"]};class i{async createSession(e){let r=this.generateSessionId(),s=new Date;s.setHours(s.getHours()+24);let a={userId:e.id,user:e,expiresAt:s,createdAt:new Date};return this.sessions.set(r,a),t.kg.info("Session created",{userId:e.id,sessionId:r.substring(0,8)+"...",expiresAt:s}),r}async getSession(e){let r=this.sessions.get(e);return r?new Date>r.expiresAt?(this.sessions.delete(e),t.kg.info("Session expired",{userId:r.userId}),null):r:null}async deleteSession(e){let r=this.sessions.get(e);r&&(this.sessions.delete(e),t.kg.info("Session deleted",{userId:r.userId}))}async refreshSession(e){let r=this.sessions.get(e);r&&(r.expiresAt=new Date,r.expiresAt.setHours(r.expiresAt.getHours()+24))}generateSessionId(){return crypto.randomUUID()}async cleanupExpiredSessions(){let e=new Date,r=0;for(let[s,t]of this.sessions.entries())e>t.expiresAt&&(this.sessions.delete(s),r++);r>0&&t.kg.info("Cleaned up expired sessions",{count:r})}constructor(){this.sessions=new Map}}class n{constructor(){this.sessionManager=new i,setInterval(()=>{this.sessionManager.cleanupExpiredSessions()},36e5)}hasPermission(e,r){return e.permissions.includes(r)||a[e.role]?.includes(r)}hasAnyPermission(e,r){return r.some(r=>this.hasPermission(e,r))}hasAllPermissions(e,r){return r.every(r=>this.hasPermission(e,r))}canAccessDealer(e,r){return"admin"===e.role||e.dealerId===r}async authenticateRequest(e){try{let r=e.headers.get("authorization"),s=null;if(r&&r.startsWith("Bearer ")&&(s=r.substring(7)),s||(s=e.cookies.get("session")?.value||null),!s)return null;let t=await this.sessionManager.getSession(s);if(!t)return null;return await this.sessionManager.refreshSession(s),t.user}catch(e){return t.kg.error("Authentication error",e instanceof Error?e:Error(String(e))),null}}async createUserSession(e){return await this.sessionManager.createSession(e)}async logout(e){await this.sessionManager.deleteSession(e)}requireAuth(){return async e=>{let r=await this.authenticateRequest(e);if(!r)throw Error("Authentication required");return r}}requirePermission(e){return async r=>{let s=await this.authenticateRequest(r);if(!s)throw Error("Authentication required");if(!this.hasPermission(s,e))throw Error(`Permission required: ${e}`);return s}}requireDealer(e){return async r=>{let s=await this.authenticateRequest(r);if(!s)throw Error("Authentication required");if(!this.canAccessDealer(s,e))throw Error("Access to dealer not allowed");return s}}}class o{constructor(){this.users=new Map,this.users.set("admin@dealershipai.com",{id:"admin-1",email:"admin@dealershipai.com",role:"admin",permissions:[],metadata:{name:"Admin User",createdAt:new Date}}),this.users.set("dealer@toyota-naples.com",{id:"dealer-1",email:"dealer@toyota-naples.com",role:"dealer",dealerId:"toyota-naples",permissions:[],metadata:{name:"Toyota Naples",createdAt:new Date}}),this.users.set("user@example.com",{id:"user-1",email:"user@example.com",role:"user",dealerId:"toyota-naples",permissions:[],metadata:{name:"Demo User",createdAt:new Date}})}async findByEmail(e){return this.users.get(e)||null}async findById(e){for(let r of this.users.values())if(r.id===e)return r;return null}async createUser(e){let r={...e,id:`user-${Date.now()}`,permissions:a[e.role]||[],metadata:{createdAt:new Date}};return this.users.set(r.email,r),r}async updateUser(e,r){let s=await this.findById(e);if(!s)return null;let t={...s,...r};return this.users.set(s.email,t),t}}let u=new n;new o}};var r=require("../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[1262,722,1123],()=>s(36138));module.exports=t})();