"use strict";(()=>{var e={};e.id=3180,e.ids=[3180],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},73292:e=>{e.exports=require("fs/promises")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},53257:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>w});var s={};r.r(s),r.d(s,{POST:()=>u});var i=r(95815),a=r(51150),n=r(10007),o=r(30596),c=r(2381),l=r(39367),d=r(90453),h=r(49457);async function u(e){try{let t=await d.Sy.authenticateRequest(e);if(!t||!d.Sy.hasPermission(t,"read:batches"))return o.Z.json({error:"Unauthorized"},{status:401});let{templateId:r,variations:s,maxPreview:i=3}=await e.json();if(!r||!s||!Array.isArray(s))return o.Z.json({error:"templateId and variations array are required"},{status:400});if(0===s.length)return o.Z.json({error:"At least one variation is required"},{status:400});let a=l.s.getTemplate(r);if(!a)return o.Z.json({error:`Template not found: ${r}`},{status:404});let n=s.slice(0,i),u=[],p=0,g=[];for(let e=0;e<n.length;e++)try{let t=await l.s.expandPrompt(r,n[e]);u.push({index:e,variables:n[e],expandedPrompt:t.expandedPrompt,tokenCount:t.metadata.tokenCount||0}),p+=t.metadata.tokenCount||0}catch(t){g.push({index:e,variables:n[e],error:t instanceof Error?t.message:String(t)})}let m=p/Math.max(u.length,1),f=Math.round(m*s.length),y=h.X.calculateCost("openai",a.settings?.model||"gpt-4o-mini",f,.3*f),w=await h.X.canProceed("openai",a.settings?.model||"gpt-4o-mini",f,Math.round(.3*f),t.id,t.dealerId),v={totalVariations:s.length,previewedVariations:u.length,erroredVariations:g.length,estimatedTokens:f,estimatedCost:y,canProceed:w.allowed,costWarning:w.allowed?void 0:w.reason,template:{id:a.id,name:a.name,description:a.description,model:a.settings?.model||"gpt-4o-mini"}};return c.kg.info("Batch preview generated",{templateId:r,userId:t.id,totalVariations:s.length,previewCount:u.length,errorCount:g.length,estimatedCost:y}),o.Z.json({success:!0,summary:v,previews:u,errors:g})}catch(e){return c.kg.error("Batch preview error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Failed to generate batch preview",details:e instanceof Error?e.message:String(e)},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/batch/preview/route",pathname:"/api/batch/preview",filename:"route",bundlePath:"app/api/batch/preview/route"},resolvedPagePath:"/Users/briankramer/Documents/GitHub/dealership-ai/apps/web/app/api/batch/preview/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f,headerHooks:y,staticGenerationBailout:w}=p,v="/api/batch/preview/route";function x(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},17856:(e,t,r)=>{r.d(t,{F:()=>o});var s=r(2381);class i{constructor(){this.cache=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),3e5)}cleanup(){let e=Date.now();for(let[t,r]of this.cache.entries())e-r.created>1e3*r.ttl&&this.cache.delete(t)}async get(e){let t=this.cache.get(e);return t?Date.now()-t.created>1e3*t.ttl?(this.cache.delete(e),null):t.value:null}async set(e,t,r=3600){this.cache.set(e,{value:t,ttl:r,created:Date.now()})}async del(e){this.cache.delete(e)}async exists(e){let t=this.cache.get(e);return!!t&&(!(Date.now()-t.created>1e3*t.ttl)||(this.cache.delete(e),!1))}async flush(){this.cache.clear()}destroy(){clearInterval(this.cleanupInterval),this.cache.clear()}}class a{constructor(){this.connected=!1,this.initRedis()}async initRedis(){try{if(!process.env.REDIS_URL){s.kg.info("No Redis URL provided, skipping Redis initialization");return}let e=(await r.e(57).then(r.t.bind(r,60057,23))).default;this.redis=new e(process.env.REDIS_URL),this.redis.on("connect",()=>{this.connected=!0,s.kg.info("Redis connected")}),this.redis.on("error",e=>{this.connected=!1,s.kg.error("Redis error",e)}),await this.redis.ping(),this.connected=!0}catch(e){s.kg.warn("Failed to initialize Redis, using in-memory cache",{error:e}),this.connected=!1}}async get(e){if(!this.connected||!this.redis)return null;try{let t=await this.redis.get(e);return t?JSON.parse(t):null}catch(e){return s.kg.error("Redis get error",e instanceof Error?e:Error(String(e))),null}}async set(e,t,r=3600){if(this.connected&&this.redis)try{await this.redis.setex(e,r,JSON.stringify(t))}catch(e){s.kg.error("Redis set error",e instanceof Error?e:Error(String(e)))}}async del(e){if(this.connected&&this.redis)try{await this.redis.del(e)}catch(e){s.kg.error("Redis del error",e instanceof Error?e:Error(String(e)))}}async exists(e){if(!this.connected||!this.redis)return!1;try{let t=await this.redis.exists(e);return 1===t}catch(e){return s.kg.error("Redis exists error",e instanceof Error?e:Error(String(e))),!1}}async flush(){if(this.connected&&this.redis)try{await this.redis.flushall()}catch(e){s.kg.error("Redis flush error",e instanceof Error?e:Error(String(e)))}}}class n{constructor(){this.redis=new a,this.memory=new i}async get(e){let t=await this.redis.get(e);return null!==t?t:t=await this.memory.get(e)}async set(e,t,r=3600){await Promise.all([this.redis.set(e,t,r),this.memory.set(e,t,r)])}async del(e){await Promise.all([this.redis.del(e),this.memory.del(e)])}async exists(e){return!!await this.redis.exists(e)||await this.memory.exists(e)}async flush(){await Promise.all([this.redis.flush(),this.memory.flush()])}async remember(e,t,r=3600){let s=await this.get(e);if(null!==s)return s;let i=await t();return await this.set(e,i,r),i}async mget(e){return Promise.all(e.map(e=>this.get(e)))}async mset(e){await Promise.all(e.map(({key:e,value:t,ttl:r=3600})=>this.set(e,t,r)))}key(e,...t){return`dealershipai:${e}:${t.join(":")}`}dealerKey(e,...t){return this.key("dealer",e,...t)}scoreKey(e,t){return this.dealerKey(e,"scores",t)}batchKey(e,...t){return this.key("batch",e,...t)}queueKey(...e){return this.key("queue",...e)}}let o=new n},2381:(e,t,r)=>{r.d(t,{hu:()=>a,kg:()=>i});class s{constructor(){this.level=process.env.LOG_LEVEL||"info",this.format=process.env.LOG_FORMAT||"json"}shouldLog(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(this.level)}formatLog(e){if("json"===this.format)return JSON.stringify({...e,error:e.error?{name:e.error.name,message:e.error.message,stack:e.error.stack}:void 0});let t=`[${e.timestamp}] ${e.level.toUpperCase()}`,r=e.context?` ${JSON.stringify(e.context)}`:"",s=e.error?`
${e.error.stack}`:"";return`${t}: ${e.message}${r}${s}`}log(e,t,r,s){if(!this.shouldLog(e))return;let i={level:e,message:t,timestamp:new Date().toISOString(),context:r,error:s},a=this.formatLog(i);"error"===e?console.error(a):"warn"===e?console.warn(a):console.log(a)}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t,r){this.log("error",e,r,t)}apiRequest(e,t,r,s){this.info("API Request",{method:e,path:t,status:r,duration_ms:s})}queueJob(e,t,r,s){let i={jobId:e,type:t,...s&&{duration_ms:s}};"failed"===r?this.error(`Queue job ${r}`,void 0,i):this.info(`Queue job ${r}`,i)}costAlert(e,t,r){this.warn("Cost threshold exceeded",{amount:e,threshold:t,period:r,excess:e-t})}}let i=new s;function a(e){let t=new s,r=t.log;return t.log=function(t,s,i,a){let n=`[${e}] ${s}`;return r.call(this,t,n,i,a)},t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1262,722,9376],()=>r(53257));module.exports=s})();