"use strict";(()=>{var e={};e.id=6433,e.ids=[6433],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},73292:e=>{e.exports=require("fs/promises")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},28143:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>b,patchFetch:()=>k,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var s={};r.r(s),r.d(s,{POST:()=>h});var a=r(95815),i=r(51150),n=r(10007),o=r(30596),l=r(2381),c=r(39367),d=r(90453),u=r(17856);async function h(e){try{let t=await d.Sy.authenticateRequest(e);if(!t||!d.Sy.hasPermission(t,"write:batches"))return o.Z.json({error:"Unauthorized"},{status:401});let{templateId:r,variations:s,batchId:a}=await e.json();if(!r||!s||!Array.isArray(s))return o.Z.json({error:"templateId and variations array are required"},{status:400});let i=c.s.getTemplate(r);if(!i)return o.Z.json({error:`Template not found: ${r}`},{status:404});let n=a||`batch_${Date.now()}_${Math.random().toString(36).substring(7)}`,h=u.F.batchKey(n),p={id:n,templateId:r,template:{name:i.name,description:i.description},totalVariations:s.length,status:"processing",createdAt:new Date().toISOString(),createdBy:t.id,results:{successful:0,failed:0,total:s.length},errors:[],completedAt:null};await u.F.set(h,p,86400),l.kg.info("Batch expansion started",{batchId:n,templateId:r,variationCount:s.length,userId:t.id});let m=[],g=[],f=0;for(let e=0;e<s.length;e++)try{let t=await c.s.expandPrompt(r,s[e]);m.push({index:e,variables:s[e],expandedPrompt:t.expandedPrompt,tokenCount:t.metadata.tokenCount||0,expandedAt:t.metadata.expandedAt}),f++,((e+1)%10==0||e===s.length-1)&&(p.results.successful=f,p.results.failed=g.length,await u.F.set(h,p,86400))}catch(r){let t={index:e,variables:s[e],error:r instanceof Error?r.message:String(r)};g.push(t),p.errors.push(t)}let w=m.reduce((e,t)=>e+t.tokenCount,0);if(w>0&&await c.s.recordTemplateUsage(r,w),p.status="completed",p.completedAt=new Date().toISOString(),p.results.successful=f,p.results.failed=g.length,await u.F.set(h,p,86400),m.length>100){let e=u.F.batchKey(n,"results");await u.F.set(e,m,86400)}let y={batchId:n,templateId:r,template:{name:i.name,description:i.description},totalVariations:s.length,successful:f,failed:g.length,totalTokens:w,status:"completed",createdAt:p.createdAt,completedAt:p.completedAt};return l.kg.info("Batch expansion completed",{batchId:n,templateId:r,successful:f,failed:g.length,totalTokens:w,userId:t.id}),o.Z.json({success:!0,batch:y,results:m.length<=100?m:void 0,errors:g.slice(0,10),message:m.length>100?"Large batch completed. Use batch status endpoint to retrieve full results.":void 0})}catch(e){return l.kg.error("Batch expansion error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Failed to process batch expansion",details:e instanceof Error?e.message:String(e)},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/batch/expand/route",pathname:"/api/batch/expand",filename:"route",bundlePath:"app/api/batch/expand/route"},resolvedPagePath:"/Users/briankramer/Documents/GitHub/dealership-ai/apps/web/app/api/batch/expand/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:w,staticGenerationBailout:y}=p,b="/api/batch/expand/route";function k(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},17856:(e,t,r)=>{r.d(t,{F:()=>o});var s=r(2381);class a{constructor(){this.cache=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),3e5)}cleanup(){let e=Date.now();for(let[t,r]of this.cache.entries())e-r.created>1e3*r.ttl&&this.cache.delete(t)}async get(e){let t=this.cache.get(e);return t?Date.now()-t.created>1e3*t.ttl?(this.cache.delete(e),null):t.value:null}async set(e,t,r=3600){this.cache.set(e,{value:t,ttl:r,created:Date.now()})}async del(e){this.cache.delete(e)}async exists(e){let t=this.cache.get(e);return!!t&&(!(Date.now()-t.created>1e3*t.ttl)||(this.cache.delete(e),!1))}async flush(){this.cache.clear()}destroy(){clearInterval(this.cleanupInterval),this.cache.clear()}}class i{constructor(){this.connected=!1,this.initRedis()}async initRedis(){try{if(!process.env.REDIS_URL){s.kg.info("No Redis URL provided, skipping Redis initialization");return}let e=(await r.e(57).then(r.t.bind(r,60057,23))).default;this.redis=new e(process.env.REDIS_URL),this.redis.on("connect",()=>{this.connected=!0,s.kg.info("Redis connected")}),this.redis.on("error",e=>{this.connected=!1,s.kg.error("Redis error",e)}),await this.redis.ping(),this.connected=!0}catch(e){s.kg.warn("Failed to initialize Redis, using in-memory cache",{error:e}),this.connected=!1}}async get(e){if(!this.connected||!this.redis)return null;try{let t=await this.redis.get(e);return t?JSON.parse(t):null}catch(e){return s.kg.error("Redis get error",e instanceof Error?e:Error(String(e))),null}}async set(e,t,r=3600){if(this.connected&&this.redis)try{await this.redis.setex(e,r,JSON.stringify(t))}catch(e){s.kg.error("Redis set error",e instanceof Error?e:Error(String(e)))}}async del(e){if(this.connected&&this.redis)try{await this.redis.del(e)}catch(e){s.kg.error("Redis del error",e instanceof Error?e:Error(String(e)))}}async exists(e){if(!this.connected||!this.redis)return!1;try{let t=await this.redis.exists(e);return 1===t}catch(e){return s.kg.error("Redis exists error",e instanceof Error?e:Error(String(e))),!1}}async flush(){if(this.connected&&this.redis)try{await this.redis.flushall()}catch(e){s.kg.error("Redis flush error",e instanceof Error?e:Error(String(e)))}}}class n{constructor(){this.redis=new i,this.memory=new a}async get(e){let t=await this.redis.get(e);return null!==t?t:t=await this.memory.get(e)}async set(e,t,r=3600){await Promise.all([this.redis.set(e,t,r),this.memory.set(e,t,r)])}async del(e){await Promise.all([this.redis.del(e),this.memory.del(e)])}async exists(e){return!!await this.redis.exists(e)||await this.memory.exists(e)}async flush(){await Promise.all([this.redis.flush(),this.memory.flush()])}async remember(e,t,r=3600){let s=await this.get(e);if(null!==s)return s;let a=await t();return await this.set(e,a,r),a}async mget(e){return Promise.all(e.map(e=>this.get(e)))}async mset(e){await Promise.all(e.map(({key:e,value:t,ttl:r=3600})=>this.set(e,t,r)))}key(e,...t){return`dealershipai:${e}:${t.join(":")}`}dealerKey(e,...t){return this.key("dealer",e,...t)}scoreKey(e,t){return this.dealerKey(e,"scores",t)}batchKey(e,...t){return this.key("batch",e,...t)}queueKey(...e){return this.key("queue",...e)}}let o=new n},2381:(e,t,r)=>{r.d(t,{hu:()=>i,kg:()=>a});class s{constructor(){this.level=process.env.LOG_LEVEL||"info",this.format=process.env.LOG_FORMAT||"json"}shouldLog(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(this.level)}formatLog(e){if("json"===this.format)return JSON.stringify({...e,error:e.error?{name:e.error.name,message:e.error.message,stack:e.error.stack}:void 0});let t=`[${e.timestamp}] ${e.level.toUpperCase()}`,r=e.context?` ${JSON.stringify(e.context)}`:"",s=e.error?`
${e.error.stack}`:"";return`${t}: ${e.message}${r}${s}`}log(e,t,r,s){if(!this.shouldLog(e))return;let a={level:e,message:t,timestamp:new Date().toISOString(),context:r,error:s},i=this.formatLog(a);"error"===e?console.error(i):"warn"===e?console.warn(i):console.log(i)}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t,r){this.log("error",e,r,t)}apiRequest(e,t,r,s){this.info("API Request",{method:e,path:t,status:r,duration_ms:s})}queueJob(e,t,r,s){let a={jobId:e,type:t,...s&&{duration_ms:s}};"failed"===r?this.error(`Queue job ${r}`,void 0,a):this.info(`Queue job ${r}`,a)}costAlert(e,t,r){this.warn("Cost threshold exceeded",{amount:e,threshold:t,period:r,excess:e-t})}}let a=new s;function i(e){let t=new s,r=t.log;return t.log=function(t,s,a,i){let n=`[${e}] ${s}`;return r.call(this,t,n,a,i)},t}},39367:(e,t,r)=>{r.d(t,{s:()=>n});var s=r(2381),a=r(17856);class i{async loadPack(e){this.validatePromptPack(e),this.packs.set(e.id,e),e.prompts.forEach(e=>{this.templates.set(e.id,e)}),await a.F.set(a.F.key("prompt-pack",e.id),e,86400),s.kg.info("Prompt pack loaded",{packId:e.id,name:e.name,promptCount:e.prompts.length})}async loadPackFromFile(e){try{let t=await Promise.resolve().then(r.t.bind(r,73292,23)),s=JSON.parse(await t.readFile(e,"utf-8"));return await this.loadPack(s),s}catch(t){throw s.kg.error("Failed to load prompt pack from file",t instanceof Error?t:Error(String(t)),{filePath:e}),t}}getPack(e){return this.packs.get(e)||null}getTemplate(e){return this.templates.get(e)||null}listPacks(){return Array.from(this.packs.values())}listTemplates(e){if(e){let t=this.getPack(e);return t?t.prompts:[]}return Array.from(this.templates.values())}searchTemplates(e,t){let r=Array.from(this.templates.values()),s=e.toLowerCase();return r.filter(e=>{let r=e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||e.metadata.tags.some(e=>e.toLowerCase().includes(s)),a=!t||e.category===t;return r&&a})}async expandPrompt(e,t){let r=this.getTemplate(e);if(!r)throw Error(`Template not found: ${e}`);this.validateVariables(r,t);let a=this.processTemplate(r.template,t),i={prompt:r.template,variables:t,expandedPrompt:a,metadata:{templateId:e,expandedAt:new Date,tokenCount:this.estimateTokenCount(a)}};return s.kg.debug("Prompt expanded",{templateId:e,variableCount:Object.keys(t).length,tokenCount:i.metadata.tokenCount}),i}async expandBatch(e){if(!this.getTemplate(e.templateId))throw Error(`Template not found: ${e.templateId}`);let t=[];for(let r of e.variations)try{let s=await this.expandPrompt(e.templateId,r);t.push(s)}catch(t){s.kg.error("Failed to expand prompt variation",t instanceof Error?t:Error(String(t)),{templateId:e.templateId,variables:r})}return s.kg.info("Batch prompt expansion completed",{templateId:e.templateId,requested:e.variations.length,successful:t.length}),t}validatePromptPack(e){if(!e.id||!e.name||!e.prompts)throw Error("Invalid prompt pack structure");e.prompts.forEach(t=>{if(!t.id||!t.name||!t.template)throw Error(`Invalid prompt template: ${t.id||"unknown"}`);let r=e.prompts.map(e=>e.id),s=r.filter((e,t)=>r.indexOf(e)!==t);if(s.length>0)throw Error(`Duplicate template IDs found: ${s.join(", ")}`)})}validateVariables(e,t){let r=e.variables.filter(e=>e.required&&!(e.name in t)).map(e=>e.name);if(r.length>0)throw Error(`Missing required variables: ${r.join(", ")}`);for(let r of e.variables){let e=t[r.name];void 0!==e&&this.validateVariable(r,e)}}validateVariable(e,t){switch(e.type){case"string":if("string"!=typeof t)throw Error(`Variable ${e.name} must be a string`);break;case"number":if("number"!=typeof t||isNaN(t))throw Error(`Variable ${e.name} must be a number`);break;case"boolean":if("boolean"!=typeof t)throw Error(`Variable ${e.name} must be a boolean`);break;case"array":if(!Array.isArray(t))throw Error(`Variable ${e.name} must be an array`);break;case"object":if("object"!=typeof t||null===t||Array.isArray(t))throw Error(`Variable ${e.name} must be an object`)}if(e.validation){let{pattern:r,min:s,max:a,options:i}=e.validation;if(r&&"string"==typeof t&&!new RegExp(r).test(t))throw Error(`Variable ${e.name} does not match required pattern`);if(void 0!==s&&"number"==typeof t&&t<s)throw Error(`Variable ${e.name} must be >= ${s}`);if(void 0!==a&&"number"==typeof t&&t>a)throw Error(`Variable ${e.name} must be <= ${a}`);if(i&&!i.includes(t))throw Error(`Variable ${e.name} must be one of: ${i.join(", ")}`)}}processTemplate(e,t){let r=e;return(r=(r=r.replace(/\{\{(\w+)\}\}/g,(e,r)=>{if(r in t){let e=t[r];return Array.isArray(e)?e.join(", "):String(e)}return e})).replace(/\{\{#if (\w+)\}\}(.*?)\{\{\/if\}\}/gs,(e,r,s)=>t[r]?s:"")).replace(/\{\{#each (\w+)\}\}(.*?)\{\{\/each\}\}/gs,(e,r,s)=>{let a=t[r];return Array.isArray(a)?a.map(e=>s.replace(/\{\{this\}\}/g,String(e))).join("\n"):""})}estimateTokenCount(e){return Math.ceil(e.length/4)}async getTemplateStats(e){let t=a.F.key("template-stats",e),r=await a.F.get(t);return{usageCount:r?.count||0,lastUsed:r?.lastUsed?new Date(r.lastUsed):null,averageTokens:r?.count?Math.round((r.totalTokens||0)/r.count):0}}async recordTemplateUsage(e,t){let r=a.F.key("template-stats",e),s=await a.F.get(r),i={count:(s?.count||0)+1,lastUsed:new Date().toISOString(),totalTokens:(s?.totalTokens||0)+t};await a.F.set(r,i,2592e3)}constructor(){this.packs=new Map,this.templates=new Map}}let n=new i},90453:(e,t,r)=>{r.d(t,{Sy:()=>l});var s=r(2381);let a={admin:["read:dashboard","write:dashboard","read:batches","write:batches","read:queue","write:queue","read:admin","write:admin","read:costs","write:costs"],dealer:["read:dashboard","write:dashboard","read:batches","write:batches","read:queue","read:costs"],user:["read:dashboard","read:batches","read:queue"],viewer:["read:dashboard"]};class i{async createSession(e){let t=this.generateSessionId(),r=new Date;r.setHours(r.getHours()+24);let a={userId:e.id,user:e,expiresAt:r,createdAt:new Date};return this.sessions.set(t,a),s.kg.info("Session created",{userId:e.id,sessionId:t.substring(0,8)+"...",expiresAt:r}),t}async getSession(e){let t=this.sessions.get(e);return t?new Date>t.expiresAt?(this.sessions.delete(e),s.kg.info("Session expired",{userId:t.userId}),null):t:null}async deleteSession(e){let t=this.sessions.get(e);t&&(this.sessions.delete(e),s.kg.info("Session deleted",{userId:t.userId}))}async refreshSession(e){let t=this.sessions.get(e);t&&(t.expiresAt=new Date,t.expiresAt.setHours(t.expiresAt.getHours()+24))}generateSessionId(){return crypto.randomUUID()}async cleanupExpiredSessions(){let e=new Date,t=0;for(let[r,s]of this.sessions.entries())e>s.expiresAt&&(this.sessions.delete(r),t++);t>0&&s.kg.info("Cleaned up expired sessions",{count:t})}constructor(){this.sessions=new Map}}class n{constructor(){this.sessionManager=new i,setInterval(()=>{this.sessionManager.cleanupExpiredSessions()},36e5)}hasPermission(e,t){return e.permissions.includes(t)||a[e.role]?.includes(t)}hasAnyPermission(e,t){return t.some(t=>this.hasPermission(e,t))}hasAllPermissions(e,t){return t.every(t=>this.hasPermission(e,t))}canAccessDealer(e,t){return"admin"===e.role||e.dealerId===t}async authenticateRequest(e){try{let t=e.headers.get("authorization"),r=null;if(t&&t.startsWith("Bearer ")&&(r=t.substring(7)),r||(r=e.cookies.get("session")?.value||null),!r)return null;let s=await this.sessionManager.getSession(r);if(!s)return null;return await this.sessionManager.refreshSession(r),s.user}catch(e){return s.kg.error("Authentication error",e instanceof Error?e:Error(String(e))),null}}async createUserSession(e){return await this.sessionManager.createSession(e)}async logout(e){await this.sessionManager.deleteSession(e)}requireAuth(){return async e=>{let t=await this.authenticateRequest(e);if(!t)throw Error("Authentication required");return t}}requirePermission(e){return async t=>{let r=await this.authenticateRequest(t);if(!r)throw Error("Authentication required");if(!this.hasPermission(r,e))throw Error(`Permission required: ${e}`);return r}}requireDealer(e){return async t=>{let r=await this.authenticateRequest(t);if(!r)throw Error("Authentication required");if(!this.canAccessDealer(r,e))throw Error("Access to dealer not allowed");return r}}}class o{constructor(){this.users=new Map,this.users.set("admin@dealershipai.com",{id:"admin-1",email:"admin@dealershipai.com",role:"admin",permissions:[],metadata:{name:"Admin User",createdAt:new Date}}),this.users.set("dealer@toyota-naples.com",{id:"dealer-1",email:"dealer@toyota-naples.com",role:"dealer",dealerId:"toyota-naples",permissions:[],metadata:{name:"Toyota Naples",createdAt:new Date}}),this.users.set("user@example.com",{id:"user-1",email:"user@example.com",role:"user",dealerId:"toyota-naples",permissions:[],metadata:{name:"Demo User",createdAt:new Date}})}async findByEmail(e){return this.users.get(e)||null}async findById(e){for(let t of this.users.values())if(t.id===e)return t;return null}async createUser(e){let t={...e,id:`user-${Date.now()}`,permissions:a[e.role]||[],metadata:{createdAt:new Date}};return this.users.set(t.email,t),t}async updateUser(e,t){let r=await this.findById(e);if(!r)return null;let s={...r,...t};return this.users.set(r.email,s),s}}let l=new n;new o}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1262,722],()=>r(28143));module.exports=s})();