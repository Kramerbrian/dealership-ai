"use strict";(()=>{var a={};a.id=1337,a.ids=[1337],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5486:a=>{a.exports=require("bcrypt")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{a.exports=require("querystring")},12412:a=>{a.exports=require("assert")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},28354:a=>{a.exports=require("util")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44651:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>L,patchFetch:()=>K,routeModule:()=>G,serverHooks:()=>J,workAsyncStorage:()=>H,workUnitAsyncStorage:()=>I});var d={};c.r(d);var e={};c.r(e),c.d(e,{GET:()=>F,POST:()=>B});var f=c(30480),g=c(24037),h=c(45492),i=c(39414),j=c(56540),k=c(261),l=c(89594),m=c(46344),n=c(81288),o=c(18123),p=c(96357),q=c(24807),r=c(51689),s=c(46494),t=c(86439),u=c(2548),v=c(35497),w=c(26315),x=c(68382),y=c(96330),z=c(88357);class A{constructor(){this.prisma=globalThis.prisma||new y.PrismaClient({log:["query","info","warn","error"]})}async connect(){try{await this.prisma.$connect(),z.vF.info("Database connected successfully")}catch(a){throw z.vF.error("Database connection failed",a instanceof Error?a:Error(String(a))),a}}async disconnect(){try{await this.prisma.$disconnect(),z.vF.info("Database disconnected")}catch(a){z.vF.error("Database disconnection failed",a instanceof Error?a:Error(String(a)))}}async query(a,b=[]){try{let c=await this.prisma.$queryRawUnsafe(a,...b);return z.vF.debug("Query executed successfully",{sql:a,params:b}),c}catch(c){throw z.vF.error("Query execution failed",c instanceof Error?c:Error(String(c)),{sql:a,params:b}),c}}async transaction(a){try{return z.vF.debug("Executing transaction"),await this.prisma.$transaction(a)}catch(a){throw z.vF.error("Transaction failed",a instanceof Error?a:Error(String(a))),a}}async healthCheck(){try{return await this.prisma.$queryRaw`SELECT 1`,!0}catch{return!1}}get client(){return this.prisma}get dealers(){return this.prisma.dealer}get users(){return this.prisma.user}get promptTemplates(){return this.prisma.promptTemplate}get promptRuns(){return this.prisma.promptRun}get batchTests(){return this.prisma.batchTest}get schemaValidations(){return this.prisma.schemaValidation}get queueJobs(){return this.prisma.queueJob}get costEntries(){return this.prisma.costEntry}}new A;let B=(0,w.ru)(async(a,b)=>{try{let{message:c,dealerId:e,context:f={}}=await a.json();if(e&&!(0,w.CX)(b,e))return v.NextResponse.json({error:"Access denied - Cannot access this dealer's AI assistant"},{status:403});if(!c)return v.NextResponse.json({error:"Message is required"},{status:400});let g=C(c),h=function(a){let b=a.split(" ").length,c=a.includes("analyze")||a.includes("compare")||a.includes("strategy"),d=(a.match(/\?/g)||[]).length>1;return b>100||c&&d?"high":b>30||c?"medium":"low"}(c),i=(0,x.Aq)(g,h),j={...f,dealerId:e,userRole:b.user.role,taskType:g,dealershipData:await D(e)};try{let a=await (0,x.pL)(c,j,i);return await (0,d.logCostEntry)({userId:b.user.id,dealerId:e,provider:a.provider,model:a.model,operation:"chat-completion",inputTokens:a.tokensUsed.input,outputTokens:a.tokensUsed.output,totalCost:a.cost,metadata:{taskType:g,complexity:h,messageLength:c.length,responseLength:a.content.length}}),v.NextResponse.json({response:a.content,dealerId:e,timestamp:a.timestamp,metadata:{provider:a.provider,model:a.model,tokensUsed:a.tokensUsed,cost:a.cost,latency:a.latency},suggestions:E(g,e)})}catch(b){console.error("AI generation failed, falling back to enhanced mock:",b);let a=function(a,b){let c=C(a),d=b.dealerId||"your dealership";return({"seo-analysis":`Based on ${d}'s current SEO profile, I recommend focusing on local search optimization first. Key areas to improve include: LocalBusiness schema markup, Google My Business optimization, and creating location-specific content. These changes typically show results within 2-4 weeks and can improve local visibility by 15-25%.`,"competitive-analysis":`In analyzing ${d}'s competitive landscape, I've identified opportunities to differentiate through enhanced customer experience and digital presence. Your main advantages appear to be in service quality and local market knowledge. I recommend leveraging these strengths while addressing any digital marketing gaps.`,"content-generation":`For ${d}, I suggest creating content that addresses common customer pain points like vehicle maintenance schedules, financing options, and seasonal driving tips. This type of helpful content builds trust and positions you as the local automotive expert.`,"data-analysis":`Looking at ${d}'s performance data, I see potential for improvement in several key metrics. Focus on tracking: website conversion rates, lead quality scores, customer lifetime value, and digital marketing ROI. These metrics will help guide your optimization efforts.`,"customer-service":`To enhance ${d}'s customer experience, consider implementing: streamlined appointment scheduling, proactive service reminders, transparent pricing communication, and follow-up satisfaction surveys. These improvements typically increase customer retention by 20-30%.`,"technical-recommendations":`For ${d}'s technical optimization, prioritize: Core Web Vitals improvements, mobile responsiveness, SSL security, and structured data implementation. These technical foundations are essential for both user experience and search engine performance.`})[c]||`I understand you're asking about ${d}'s operations. While I'm currently experiencing some connectivity issues with my advanced AI systems, I can still provide guidance based on automotive industry best practices and dealership optimization strategies. How would you like me to help you improve your dealership's performance?`}(c,j);return v.NextResponse.json({response:a,dealerId:e,timestamp:new Date().toISOString(),metadata:{provider:"fallback",model:"enhanced-mock",fallbackReason:"ai-service-unavailable"},suggestions:E(g,e)})}}catch(a){return console.error("AI Chat API error:",a),v.NextResponse.json({error:"Failed to process chat request"},{status:500})}});function C(a){let b=a.toLowerCase();return b.includes("seo")||b.includes("search")?"seo-analysis":b.includes("competitor")||b.includes("competition")?"competitive-analysis":b.includes("content")||b.includes("write")||b.includes("create")?"content-generation":b.includes("data")||b.includes("metric")||b.includes("analytics")?"data-analysis":b.includes("customer")||b.includes("service")||b.includes("help")?"customer-service":b.includes("technical")||b.includes("implement")||b.includes("setup")?"technical-recommendations":"general"}async function D(a){if(!a)return{};try{let b=await fetch(`${process.env.NEXTAUTH_URL}/api/dashboard/enhanced?dealerId=${a}`,{headers:{"x-internal-request":"true"}});if(b.ok)return await b.json()}catch(a){console.error("Failed to fetch dealership data:",a)}return{}}function E(a,b){let c={"seo-analysis":["Show me my current SEO breakdown","What are my quick SEO wins?","How can I improve my local search ranking?","Analyze my website's technical SEO"],"competitive-analysis":["Who are my main competitors?","Compare my performance to competitors","What advantages do I have over competitors?","How can I differentiate from competition?"],"content-generation":["Write a blog post about car maintenance","Create social media content for this month","Generate FAQ answers for common questions","Help me write promotional content"],"data-analysis":["Analyze my website traffic trends","Show me my conversion funnel","What metrics should I focus on?","Create a performance report"],"customer-service":["How can I improve customer satisfaction?","Help me handle customer complaints","Create a customer onboarding process","Improve my sales process"],"technical-recommendations":["What technical improvements should I make?","Help me set up Google Analytics 4","Implement schema markup","Optimize my website speed"]}[a]||["Analyze my current performance","What should I focus on first?","Show me improvement opportunities","Help me create an action plan"];return b?c.map(a=>a.replace("my ",`${b}'s `)):c}async function F(a){return v.NextResponse.json({status:"AI Chat API is running",endpoints:{chat:"POST /api/ai/chat",stream:"POST /api/ai/chat/stream"},providers:["OpenAI GPT-4","Anthropic Claude"],models:{openai:"gpt-4-turbo-preview",claude:"claude-3-sonnet-20240229"},features:["real-ai-integration","contextual-responses","dealer-analytics","seo-recommendations","cost-tracking","intelligent-model-selection"]})}let G=new f.AppRouteRouteModule({definition:{kind:g.RouteKind.APP_ROUTE,page:"/api/ai/chat/route",pathname:"/api/ai/chat",filename:"route",bundlePath:"app/api/ai/chat/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/briankramer/dealership-ai/apps/web/app/api/ai/chat/route.ts",nextConfigOutput:"standalone",userland:e}),{workAsyncStorage:H,workUnitAsyncStorage:I,serverHooks:J}=G;function K(){return(0,h.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:I})}async function L(a,b,c){var d;let e="/api/ai/chat/route";"/index"===e&&(e="/");let f=await G.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!f)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:h,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=f,D=(0,k.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new t.NoFallbackError}let F=null;!E||G.isDev||x||(F="/index"===(F=C)?"/":F);let H=!0===G.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,j.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>G.onRequestError(a,b,d,z)},sharedContext:{buildId:h}},N=new l.NodeNextRequest(a),O=new l.NodeNextResponse(b),P=m.NextRequestAdapter.fromNodeNextRequest(N,(0,m.signalFromNodeResponse)(b));try{let d=async c=>G.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==n.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),f=async f=>{var h,j;let k=async({previousCacheEntry:g})=>{try{if(!(0,i.getRequestMeta)(a,"minimalMode")&&A&&B&&!g)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(f);a.fetchMetrics=M.renderOpts.fetchMetrics;let h=M.renderOpts.pendingWaitUntil;h&&c.waitUntil&&(c.waitUntil(h),h=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,p.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,q.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[s.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=s.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=s.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:u.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==g?void 0:g.isStale)&&await G.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,o.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await G.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:g.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(h=l.value)?void 0:h.kind)!==u.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,i.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,q.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,i.getRequestMeta)(a,"minimalMode")&&E||m.delete(s.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,r.getCacheControlHeader)(l.cacheControl)),await (0,p.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await f(L):await K.withPropagatedContext(a.headers,()=>K.trace(n.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},f))}catch(b){if(L||b instanceof t.NoFallbackError||await G.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,o.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,p.I)(N,O,new Response(null,{status:500})),null}}},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{a.exports=require("zlib")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{a.exports=require("events")},96330:a=>{a.exports=require("@prisma/client")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[6118,810,3224,8298],()=>b(b.s=44651));module.exports=c})();