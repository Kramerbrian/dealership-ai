"use strict";(()=>{var e={};e.id=4912,e.ids=[4912],e.modules={53524:e=>{e.exports=require("@prisma/client")},67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},37986:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>g,originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var i={};t.r(i),t.d(i,{GET:()=>c,POST:()=>c});var n=t(95815),a=t(51150),s=t(10007),o=t(68486),u=t.n(o),l=t(59001);let c=u()(l.Lz),d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/[...nextauth]/route",pathname:"/api/auth/[...nextauth]",filename:"route",bundlePath:"app/api/auth/[...nextauth]/route"},resolvedPagePath:"/Users/briankramer/Documents/GitHub/dealership-ai/apps/web/app/api/auth/[...nextauth]/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:g,staticGenerationBailout:f}=d,w="/api/auth/[...nextauth]/route";function v(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},59001:(e,r,t)=>{t.d(r,{Lz:()=>p,QO:()=>g,rP:()=>h});var i=t(30596),n=t(81629),a=t(35163),s=t(16573),o=t(53524),u=t(67096),l=t.n(u);let c=(0,t(2381).hu)("auth"),d=new o.PrismaClient,p={adapter:(0,n.N)(d),providers:[(0,s.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,allowDangerousEmailAccountLinking:!0}),(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return c.warn("Missing credentials in auth attempt"),null;try{let r=await d.user.findUnique({where:{email:e.email},include:{dealer:!0}});if(!r)return c.warn({email:e.email},"User not found"),null;if(!r.isActive)return c.warn({email:e.email},"Inactive user attempted login"),null;if(r.passwordHash&&!await l().compare(e.password,r.passwordHash))return c.warn({email:e.email},"Invalid password"),null;return c.info({userId:r.id,email:r.email,role:r.role,dealerId:r.dealerId},"User authenticated successfully"),{id:r.id,email:r.email,name:r.name,image:r.image,role:r.role,dealerId:r.dealerId,isActive:r.isActive}}catch(r){return c.error({error:r,email:e.email},"Authentication error"),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="google")try{let r=await d.user.findUnique({where:{email:e.email}});if(r){if(!r.isActive)return c.warn({email:e.email},"Inactive user attempted Google login"),!1}else{let r=await d.user.create({data:{email:e.email,name:e.name||t?.name||null,image:e.image||t?.picture||null,role:"user",emailVerified:new Date,isActive:!0}});c.info({userId:r.id,email:r.email,provider:"google"},"New Google user created")}}catch(r){return c.error({error:r,email:e.email},"Google sign-in error"),!1}return!0},jwt:async({token:e,user:r,trigger:t,session:i})=>(r&&(e.id=r.id,e.role=r.role,e.dealerId=r.dealerId,e.isActive=r.isActive),"update"===t&&i&&(e.role=i.role||e.role,e.dealerId=i.dealerId||e.dealerId),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.id,e.user.role=r.role,e.user.dealerId=r.dealerId,e.user.isActive=r.isActive),e)},pages:{signIn:"/auth/signin",signUp:"/auth/signup",error:"/auth/error"},events:{signIn:async({user:e,account:r,isNewUser:t})=>{c.info({userId:e.id,email:e.email,provider:r?.provider,isNewUser:t},"User signed in")},signOut:async({token:e})=>{c.info({userId:e?.id,email:e?.email},"User signed out")}},debug:!1,secret:process.env.NEXTAUTH_SECRET};function m(e,r){return e?.user?.role===r}function h(e,r){return!!m(e,"admin")||e?.user?.dealerId===r}function g(e,r={}){return async n=>{try{let{getServerSession:a}=await Promise.all([t.e(4955),t.e(8486)]).then(t.t.bind(t,68486,23)),s=await a(p);if(!s)return i.Z.json({error:"Unauthorized - Please sign in"},{status:401});if(!s.user.isActive)return i.Z.json({error:"Account inactive - Please contact support"},{status:403});if(r.requireRole&&!m(s,r.requireRole))return i.Z.json({error:`Insufficient permissions - ${r.requireRole} role required`},{status:403});if(r.requireDealer&&!s.user.dealerId)return i.Z.json({error:"Dealer access required - Please associate with a dealership"},{status:403});return e(n,s)}catch(e){return c.error({error:e,url:n.url,method:n.method},"Authentication middleware error"),i.Z.json({error:"Authentication service unavailable"},{status:503})}}}},2381:(e,r,t)=>{t.d(r,{hu:()=>a,kg:()=>n});class i{constructor(){this.level=process.env.LOG_LEVEL||"info",this.format=process.env.LOG_FORMAT||"json"}shouldLog(e){let r=["debug","info","warn","error"];return r.indexOf(e)>=r.indexOf(this.level)}formatLog(e){if("json"===this.format)return JSON.stringify({...e,error:e.error?{name:e.error.name,message:e.error.message,stack:e.error.stack}:void 0});let r=`[${e.timestamp}] ${e.level.toUpperCase()}`,t=e.context?` ${JSON.stringify(e.context)}`:"",i=e.error?`
${e.error.stack}`:"";return`${r}: ${e.message}${t}${i}`}log(e,r,t,i){if(!this.shouldLog(e))return;let n={level:e,message:r,timestamp:new Date().toISOString(),context:t,error:i},a=this.formatLog(n);"error"===e?console.error(a):"warn"===e?console.warn(a):console.log(a)}debug(e,r){this.log("debug",e,r)}info(e,r){this.log("info",e,r)}warn(e,r){this.log("warn",e,r)}error(e,r,t){this.log("error",e,t,r)}apiRequest(e,r,t,i){this.info("API Request",{method:e,path:r,status:t,duration_ms:i})}queueJob(e,r,t,i){let n={jobId:e,type:r,...i&&{duration_ms:i}};"failed"===t?this.error(`Queue job ${t}`,void 0,n):this.info(`Queue job ${t}`,n)}costAlert(e,r,t){this.warn("Cost threshold exceeded",{amount:e,threshold:r,period:t,excess:e-r})}}let n=new i;function a(e){let r=new i,t=r.log;return r.log=function(r,i,n,a){let s=`[${e}] ${i}`;return t.call(this,r,s,n,a)},r}},35163:(e,r)=>{r.Z=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},16573:(e,r)=>{r.Z=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},81629:(e,r,t)=>{function i(e){return{createUser:({id:r,...t})=>e.user.create(n(t)),getUser:r=>e.user.findUnique({where:{id:r}}),getUserByEmail:r=>e.user.findUnique({where:{email:r}}),async getUserByAccount(r){let t=await e.account.findUnique({where:{provider_providerAccountId:r},include:{user:!0}});return t?.user??null},updateUser:({id:r,...t})=>e.user.update({where:{id:r},...n(t)}),deleteUser:r=>e.user.delete({where:{id:r}}),linkAccount:r=>e.account.create({data:r}),unlinkAccount:r=>e.account.delete({where:{provider_providerAccountId:r}}),async getSessionAndUser(r){let t=await e.session.findUnique({where:{sessionToken:r},include:{user:!0}});if(!t)return null;let{user:i,...n}=t;return{user:i,session:n}},createSession:r=>e.session.create(n(r)),updateSession:r=>e.session.update({where:{sessionToken:r.sessionToken},...n(r)}),deleteSession:r=>e.session.delete({where:{sessionToken:r}}),async createVerificationToken(r){let t=await e.verificationToken.create(n(r));return"id"in t&&t.id&&delete t.id,t},async useVerificationToken(r){try{let t=await e.verificationToken.delete({where:{identifier_token:r}});return"id"in t&&t.id&&delete t.id,t}catch(e){if(e&&"object"==typeof e&&"code"in e&&"P2025"===e.code)return null;throw e}},getAccount:async(r,t)=>e.account.findFirst({where:{providerAccountId:r,provider:t}}),createAuthenticator:async r=>e.authenticator.create(n(r)),getAuthenticator:async r=>e.authenticator.findUnique({where:{credentialID:r}}),listAuthenticatorsByUserId:async r=>e.authenticator.findMany({where:{userId:r}}),updateAuthenticatorCounter:async(r,t)=>e.authenticator.update({where:{credentialID:r},data:{counter:t}})}}function n(e){let r={};for(let t in e)void 0!==e[t]&&(r[t]=e[t]);return{data:r}}t.d(r,{N:()=>i})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[1262,722,4955,8486],()=>t(37986));module.exports=i})();