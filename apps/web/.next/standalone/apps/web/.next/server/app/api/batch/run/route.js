"use strict";(()=>{var e={};e.id=5493,e.ids=[5493],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},73292:e=>{e.exports=require("fs/promises")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},96864:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>x,originalPathname:()=>b,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>k,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>S});var s={};r.r(s),r.d(s,{POST:()=>p});var a=r(95815),i=r(51150),n=r(10007),o=r(30596),c=r(2381),l=r(39367),d=r(90453),u=r(49457),h=r(17856);async function p(e){try{let t=await d.Sy.authenticateRequest(e);if(!t||!d.Sy.hasPermission(t,"write:batches"))return o.Z.json({error:"Unauthorized"},{status:401});let{templateId:r,variations:s,settings:a={},batchId:i,runAsync:n=!1}=await e.json();if(!r||!s||!Array.isArray(s))return o.Z.json({error:"templateId and variations array are required"},{status:400});let p=l.s.getTemplate(r);if(!p)return o.Z.json({error:`Template not found: ${r}`},{status:404});let f={...p.settings,...a,model:a.model||p.settings?.model||"gpt-4o-mini"},w=500*s.length,y=Math.round(.3*w),k=await u.X.canProceed("openai",f.model,w,y,t.id,t.dealerId);if(!k.allowed)return o.Z.json({error:"Cost limit exceeded",details:k.reason,currentCost:k.currentCost,limit:k.limit},{status:429});let x=i||`run_${Date.now()}_${Math.random().toString(36).substring(7)}`,S=h.F.batchKey(x),b={id:x,type:"run",templateId:r,template:{name:p.name,description:p.description},settings:f,totalVariations:s.length,status:"queued",createdAt:new Date().toISOString(),createdBy:t.id,dealerId:t.dealerId,progress:{completed:0,failed:0,total:s.length,currentStep:"initializing"},results:[],errors:[],costTracking:{estimatedCost:u.X.calculateCost("openai",f.model,w,y),actualCost:0,tokensUsed:0},startedAt:null,completedAt:null};if(await h.F.set(S,b,86400),c.kg.info("Batch run initiated",{batchId:x,templateId:r,variationCount:s.length,userId:t.id,runAsync:n,estimatedCost:b.costTracking.estimatedCost}),n)return b.status="queued",await h.F.set(S,b,86400),m(x,r,s,f,t),o.Z.json({success:!0,batchId:x,status:"queued",message:"Batch queued for processing. Use batch status endpoint to check progress.",estimatedCost:b.costTracking.estimatedCost,estimatedDuration:Math.ceil(s.length/10)+" minutes"});b.status="processing",b.startedAt=new Date().toISOString(),b.progress.currentStep="expanding_prompts",await h.F.set(S,b,86400);let v=[],T=[],I=0,q=0;for(let e=0;e<s.length;e++)try{let a=await l.s.expandPrompt(r,s[e]),i=await g(a.expandedPrompt,f),n=u.X.calculateCost("openai",f.model,a.metadata.tokenCount||0,i.outputTokens);await u.X.recordCost({provider:"openai",model:f.model,operation:"completion",inputTokens:a.metadata.tokenCount||0,outputTokens:i.outputTokens,userId:t.id,dealerId:t.dealerId,batchId:x});let o={index:e,variables:s[e],expandedPrompt:a.expandedPrompt,response:i.content,metadata:{inputTokens:a.metadata.tokenCount||0,outputTokens:i.outputTokens,cost:n,processingTime:i.processingTime,model:f.model},completedAt:new Date().toISOString()};v.push(o),I+=(a.metadata.tokenCount||0)+i.outputTokens,q+=n,b.progress.completed=e+1,b.costTracking.actualCost=q,b.costTracking.tokensUsed=I,(e+1)%10==0&&await h.F.set(S,b,86400)}catch(r){let t={index:e,variables:s[e],error:r instanceof Error?r.message:String(r),timestamp:new Date().toISOString()};T.push(t),b.progress.failed++}b.status="completed",b.completedAt=new Date().toISOString(),b.progress.currentStep="completed",b.results=v,b.errors=T,b.costTracking.actualCost=q,b.costTracking.tokensUsed=I,await h.F.set(S,b,86400),I>0&&await l.s.recordTemplateUsage(r,I);let R={batchId:x,status:"completed",results:{successful:v.length,failed:T.length,total:s.length},costTracking:b.costTracking,duration:new Date().getTime()-new Date(b.createdAt).getTime(),createdAt:b.createdAt,completedAt:b.completedAt};return c.kg.info("Batch run completed",{batchId:x,successful:v.length,failed:T.length,actualCost:q,totalTokens:I,userId:t.id}),o.Z.json({success:!0,batch:R,results:v.slice(0,50),errors:T.slice(0,10),message:v.length>50?"Large batch completed. Use batch status endpoint to retrieve full results.":void 0})}catch(e){return c.kg.error("Batch run error",e instanceof Error?e:Error(String(e))),o.Z.json({error:"Failed to process batch run",details:e instanceof Error?e.message:String(e)},{status:500})}}async function g(e,t){await new Promise(e=>setTimeout(e,100+200*Math.random()));let r=Math.round(50+200*Math.random());return{content:`[Simulated AI Response]
Based on: ${e.substring(0,100)}...
Model: ${t.model}
Length: ${r} tokens`,outputTokens:r,processingTime:100+200*Math.random()}}async function m(e,t,r,s,a){setTimeout(async()=>{try{let s=h.F.batchKey(e),a=await h.F.get(s);if(!a)return;a.status="processing",a.startedAt=new Date().toISOString(),await h.F.set(s,a,86400),a.status="completed",a.completedAt=new Date().toISOString(),await h.F.set(s,a,86400),c.kg.info("Background batch processing completed",{batchId:e,templateId:t,variationCount:r.length})}catch(e){c.kg.error("Background batch processing error",e instanceof Error?e:Error(String(e)))}},1e3)}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/batch/run/route",pathname:"/api/batch/run",filename:"route",bundlePath:"app/api/batch/run/route"},resolvedPagePath:"/Users/briankramer/Documents/GitHub/dealership-ai/apps/web/app/api/batch/run/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:k,headerHooks:x,staticGenerationBailout:S}=f,b="/api/batch/run/route";function v(){return(0,n.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:y})}},17856:(e,t,r)=>{r.d(t,{F:()=>o});var s=r(2381);class a{constructor(){this.cache=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),3e5)}cleanup(){let e=Date.now();for(let[t,r]of this.cache.entries())e-r.created>1e3*r.ttl&&this.cache.delete(t)}async get(e){let t=this.cache.get(e);return t?Date.now()-t.created>1e3*t.ttl?(this.cache.delete(e),null):t.value:null}async set(e,t,r=3600){this.cache.set(e,{value:t,ttl:r,created:Date.now()})}async del(e){this.cache.delete(e)}async exists(e){let t=this.cache.get(e);return!!t&&(!(Date.now()-t.created>1e3*t.ttl)||(this.cache.delete(e),!1))}async flush(){this.cache.clear()}destroy(){clearInterval(this.cleanupInterval),this.cache.clear()}}class i{constructor(){this.connected=!1,this.initRedis()}async initRedis(){try{if(!process.env.REDIS_URL){s.kg.info("No Redis URL provided, skipping Redis initialization");return}let e=(await r.e(57).then(r.t.bind(r,60057,23))).default;this.redis=new e(process.env.REDIS_URL),this.redis.on("connect",()=>{this.connected=!0,s.kg.info("Redis connected")}),this.redis.on("error",e=>{this.connected=!1,s.kg.error("Redis error",e)}),await this.redis.ping(),this.connected=!0}catch(e){s.kg.warn("Failed to initialize Redis, using in-memory cache",{error:e}),this.connected=!1}}async get(e){if(!this.connected||!this.redis)return null;try{let t=await this.redis.get(e);return t?JSON.parse(t):null}catch(e){return s.kg.error("Redis get error",e instanceof Error?e:Error(String(e))),null}}async set(e,t,r=3600){if(this.connected&&this.redis)try{await this.redis.setex(e,r,JSON.stringify(t))}catch(e){s.kg.error("Redis set error",e instanceof Error?e:Error(String(e)))}}async del(e){if(this.connected&&this.redis)try{await this.redis.del(e)}catch(e){s.kg.error("Redis del error",e instanceof Error?e:Error(String(e)))}}async exists(e){if(!this.connected||!this.redis)return!1;try{let t=await this.redis.exists(e);return 1===t}catch(e){return s.kg.error("Redis exists error",e instanceof Error?e:Error(String(e))),!1}}async flush(){if(this.connected&&this.redis)try{await this.redis.flushall()}catch(e){s.kg.error("Redis flush error",e instanceof Error?e:Error(String(e)))}}}class n{constructor(){this.redis=new i,this.memory=new a}async get(e){let t=await this.redis.get(e);return null!==t?t:t=await this.memory.get(e)}async set(e,t,r=3600){await Promise.all([this.redis.set(e,t,r),this.memory.set(e,t,r)])}async del(e){await Promise.all([this.redis.del(e),this.memory.del(e)])}async exists(e){return!!await this.redis.exists(e)||await this.memory.exists(e)}async flush(){await Promise.all([this.redis.flush(),this.memory.flush()])}async remember(e,t,r=3600){let s=await this.get(e);if(null!==s)return s;let a=await t();return await this.set(e,a,r),a}async mget(e){return Promise.all(e.map(e=>this.get(e)))}async mset(e){await Promise.all(e.map(({key:e,value:t,ttl:r=3600})=>this.set(e,t,r)))}key(e,...t){return`dealershipai:${e}:${t.join(":")}`}dealerKey(e,...t){return this.key("dealer",e,...t)}scoreKey(e,t){return this.dealerKey(e,"scores",t)}batchKey(e,...t){return this.key("batch",e,...t)}queueKey(...e){return this.key("queue",...e)}}let o=new n},2381:(e,t,r)=>{r.d(t,{hu:()=>i,kg:()=>a});class s{constructor(){this.level=process.env.LOG_LEVEL||"info",this.format=process.env.LOG_FORMAT||"json"}shouldLog(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(this.level)}formatLog(e){if("json"===this.format)return JSON.stringify({...e,error:e.error?{name:e.error.name,message:e.error.message,stack:e.error.stack}:void 0});let t=`[${e.timestamp}] ${e.level.toUpperCase()}`,r=e.context?` ${JSON.stringify(e.context)}`:"",s=e.error?`
${e.error.stack}`:"";return`${t}: ${e.message}${r}${s}`}log(e,t,r,s){if(!this.shouldLog(e))return;let a={level:e,message:t,timestamp:new Date().toISOString(),context:r,error:s},i=this.formatLog(a);"error"===e?console.error(i):"warn"===e?console.warn(i):console.log(i)}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t,r){this.log("error",e,r,t)}apiRequest(e,t,r,s){this.info("API Request",{method:e,path:t,status:r,duration_ms:s})}queueJob(e,t,r,s){let a={jobId:e,type:t,...s&&{duration_ms:s}};"failed"===r?this.error(`Queue job ${r}`,void 0,a):this.info(`Queue job ${r}`,a)}costAlert(e,t,r){this.warn("Cost threshold exceeded",{amount:e,threshold:t,period:r,excess:e-t})}}let a=new s;function i(e){let t=new s,r=t.log;return t.log=function(t,s,a,i){let n=`[${e}] ${s}`;return r.call(this,t,n,a,i)},t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1262,722,9376],()=>r(96864));module.exports=s})();